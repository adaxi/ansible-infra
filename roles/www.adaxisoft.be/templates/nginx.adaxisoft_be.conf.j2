upstream php_adaxisoft_be {
    server unix:/var/run/php5-fpm-{{adaxisoft_be_user}}.sock;
}

server {
       listen           80;
       listen           [::]:80;
       server_name      {{adaxisoft_be_domain}} www.{{adaxisoft_be_domain}};
       return           301 https://$server_name$request_uri;
}

server {
    listen              443 ssl;
    listen              [::]:443 ssl;
    ssl_certificate     /etc/{{ "ssl-external" if installation_environment == "production" else "selfsigned" }}/live/{{adaxisoft_be_domain}}/fullchain.pem;
    ssl_certificate_key /etc/{{ "ssl-external" if installation_environment == "production" else "selfsigned" }}/live/{{adaxisoft_be_domain}}/privkey.pem;
    keepalive_timeout   70;

    server_name         {{adaxisoft_be_domain}} www.{{adaxisoft_be_domain}};
    root                {{adaxisoft_be_home}};
    access_log          /var/log/nginx/{{adaxisoft_be_domain}}.access.log	combined;
    error_log           /var/log/nginx/{{adaxisoft_be_domain}}.error.log    error;

    location / {
        index           index.html index.php;
    }

    # deny access to .dotfiles files
    location ~ /\. {
        deny            all;
        access_log      off;
        log_not_found   off;
    }

	# Cache image and scripts
	location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
        expires         max;
        log_not_found   off;
    }

    location /api {
    	proxy_pass http://unix:/var/run/adaxisoft-api/adaxisoft-api.sock;
    	proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }


    location /blog {
		index   index.html index.htm index.php;
		try_files $uri $uri/ /blog/index.php?$args;
	}

	location ~ \.php$ {
		# Prevent Zero-day exploit
		try_files $uri =404;

		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		#NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini

		fastcgi_pass    php_adaxisoft_be;
		fastcgi_index   index.php;
		fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;
		include         fastcgi_params;
	}




}
